# === Purpose ===
#
# This test case will verify the function of innodb lock wait log
#
--source include/not_windows.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--disable_warnings
drop database if exists linpin;
--enable_warnings

# Save the old values of these variables to be restored at the end
SET @old_transaction_isolation=	 	 @@global.transaction_isolation;
SET @old_innodb_lock_wait_timeout=	 @@global.innodb_lock_wait_timeout;
SET @old_lock_wait_timeout=	 		 @@global.lock_wait_timeout;

set GLOBAL transaction_isolation = 	 'READ-COMMITTED';
SET GLOBAL innodb_lock_wait_timeout= 1;
SET GLOBAL lock_wait_timeout=	     1;

create database linpin;
use linpin;

--disable_warnings
drop table if exists t20;
drop table if exists t21;
drop table if exists t22;
--enable_warnings

create table t20(id int, name varchar(80));
insert into t20 values(1,'linpin');
insert into t20 values(2,'lishiming');
insert into t20 values(3,'qinshihuang');
insert into t20 values(4,'hanwudi');
insert into t20 values(5,'5hangaozu');
insert into t20 values(6,'6hangaozu');
insert into t20 values(10,'5hangaozu');
insert into t20 values(11,'6hangaozu');
insert into t20 values(12,'5hangaozu');
insert into t20 values(13,'6hangaozu');

create table t21(id int, name varchar(80));
insert into t21 values(1,'linpin');
insert into t21 values(2,'lishiming');
insert into t21 values(3,'qinshihuang');
insert into t21 values(4,'hanwudi');
insert into t21 values(5,'5hangaozu');
insert into t21 values(6,'6hangaozu');
insert into t21 values(10,'5hangaozu');
insert into t21 values(11,'6hangaozu');
insert into t21 values(12,'5hangaozu');
insert into t21 values(13,'6hangaozu');

create table t22(id int, name varchar(80));
insert into t22 values(1,'linpin');
insert into t22 values(2,'lishiming');
insert into t22 values(3,'qinshihuang');
insert into t22 values(4,'hanwudi');
insert into t22 values(5,'5hangaozu');
insert into t22 values(6,'6hangaozu');
insert into t22 values(10,'5hangaozu');
insert into t22 values(11,'6hangaozu');
insert into t22 values(12,'5hangaozu');
insert into t22 values(13,'6hangaozu');


#########################################################
########### cluster index without primary key ###########
#########################################################


############# two locks on the same record ##############

# without TSN

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
--error 1205
update t20 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;


# with TSN

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
/*+TSN=mycase-0001*/start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
/*+TSN=mycase-0002*/start transaction;
--error 1205
update t20 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;


# with gtid

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
/*+GTID=1234578*/start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
/*+GTID=1234579*/start transaction;
--error 1205
update t20 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;


# with gtid and with gtid

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
/*+TSN=mycase-0001*/ /*+GTID=1234578*/start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
/*+TSN=mycase-0002*/ /*+GTID=1234579*/start transaction;
--error 1205
update t20 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;


############# two locks on the diff record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
update t20 set name='2222zzzzzzzz' where id = 5;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;


############# four locks on the same record #############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
send update t20 set name='2222zzzzzzzz' where id = 4;

connection con3;
use linpin;
start transaction;
send update t20 set name='3333zzzzzzzz' where id = 4;

connection con4;
use linpin;
start transaction;
--error 1205
update t20 set name='3333zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


############# two locks, two have one lock ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
send update t20 set name='5ddddddd' where id = 5;

connection con3;
use linpin;
start transaction;
update t20 set name='6dddddd' where id = 6;

connection con4;
use linpin;
start transaction;
--error 1205
update t20 set name='6dddd' where id = 6;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


################### update and insert ###################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
insert into t20 values(5, 'xxxx');

connection con3;
use linpin;
start transaction;
insert into t20 values(6, 'xxxx');

connection con4;
use linpin;
start transaction;
insert into t20 values(3, 'xxxx');

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


##################### table lock 1 ######################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection default;
SET @old_innodb_status_output_locks=	 	 @@global.innodb_status_output_locks;
set global innodb_status_output_locks = 	 on;

connection con1;
use linpin;
start transaction;
update t20 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
insert into t20 values(5, 'xxxx');

connection con3;
use linpin;
--error 1205
LOCK TABLES t20 read;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;
disconnect con3;

connection default;
set global innodb_status_output_locks = 	 @old_innodb_status_output_locks;


##################### table lock 2 ######################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
LOCK TABLES t20 write;

connection con2;
use linpin;
start transaction;
send update t20 set name='5zzzzz' where id = 5;

connection con3;
use linpin;
--error 1205
insert into t20 values(5, 'xxxx');

connection default;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con1;
UNLOCK TABLES;

disconnect con1;
disconnect con2;
disconnect con3;


################### diff tables lock ####################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t20 set name='5zzzzz' where id = 5;
update t21 set name='5zzzzz' where id = 6;

connection con2;
use linpin;
start transaction;
update t22 set name='5zzzzz' where id = 7;
send update t21 set name='5zzzzz' where id = 6;

connection con3;
use linpin;
start transaction;
--error 1205
update t20 set name='5zzzzz' where id = 5;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t20;
--enable_warnings
create table tmp_t20(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
--enable_query_log
select count(*) from tmp_t20;
drop table tmp_t20;

disconnect con1;
disconnect con2;
disconnect con3;



connection default;

##!!!!!! start only for test
#--disable_warnings
#drop table if exists tmp_t20;
#--enable_warnings
#create table tmp_t20(lock_wait_string varchar(256));
#--disable_query_log
#eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t20;
#--enable_query_log
#select count(*) from tmp_t20;
#select * from tmp_t20;
#drop table tmp_t20;
##!!!!!!  end  only for test


SET GLOBAL innodb_lock_wait_timeout= @old_innodb_lock_wait_timeout;
SET GLOBAL transaction_isolation=	 @old_transaction_isolation;
SET GLOBAL lock_wait_timeout=	     @old_lock_wait_timeout;

drop table t20;
drop table t21;
drop table t22;
drop database linpin;







# === Purpose ===
#
# This test case will verify the function of innodb lock wait log
#
#--source include/not_embedded.inc
--source include/not_windows.inc
#--source include/have_innodb.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--disable_warnings
drop database if exists linpin;
--enable_warnings

# Save the old values of these variables to be restored at the end
SET @old_transaction_isolation=	 	 @@global.transaction_isolation;
SET @old_innodb_lock_wait_timeout=	 @@global.innodb_lock_wait_timeout;
SET @old_lock_wait_timeout=	 		 @@global.lock_wait_timeout;

set GLOBAL transaction_isolation = 	 'READ-COMMITTED';
SET GLOBAL innodb_lock_wait_timeout= 1;
SET GLOBAL lock_wait_timeout=	     3;

create database linpin;
use linpin;

--disable_warnings
drop table if exists t30;
drop table if exists t31;
--enable_warnings

create table t30(id int primary key, name varchar(80));
insert into t30 values(1,'linpin');
insert into t30 values(2,'lishiming');
insert into t30 values(3,'qinshihuang');
insert into t30 values(4,'hanwudi');
insert into t30 values(5,'5hangaozu');
insert into t30 values(6,'6hangaozu');
insert into t30 values(10,'5hangaozu');
insert into t30 values(11,'6hangaozu');
insert into t30 values(12,'5hangaozu');
insert into t30 values(13,'6hangaozu');

create table t31(id int AUTO_INCREMENT primary key, name varchar(80));
insert into t31 values(1,'linpin');
insert into t31 values(2,'lishiming');
insert into t31 values(3,'qinshihuang');
insert into t31 values(4,'hanwudi');


#########################################################
############ cluster index with primary key #############
#########################################################


############# two locks on the same record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t30 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
--error 1205
update t30 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;
--disable_query_log

disconnect con1;
disconnect con2;


############# two locks on the diff record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t30 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
update t30 set name='2222zzzzzzzz' where id = 5;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;


############# four locks on the same record #############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t30 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
send update t30 set name='2222zzzzzzzz' where id = 4;

connection con3;
use linpin;
start transaction;
send update t30 set name='3333zzzzzzzz' where id = 4;

connection con4;
use linpin;
start transaction;
--error 1205
update t30 set name='3333zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con3;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


############# two locks, two have one lock ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t30 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
send update t30 set name='5ddddddd' where id = 5;

connection con3;
use linpin;
start transaction;
update t30 set name='6dddddd' where id = 6;

connection con4;
use linpin;
start transaction;
--error 1205
update t30 set name='6dddd' where id = 6;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


################### update and insert ###################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t30 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
insert into t30 values(100, 'xxxx');

connection con3;
use linpin;
start transaction;
--error 1062
insert into t30 values(4, 'xxxx');

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;
disconnect con3;


################### AUTO-INC locks 1 ####################

connection default;
SET @tmp_innodb_lock_wait_timeout=	 @@global.innodb_lock_wait_timeout;
SET GLOBAL innodb_lock_wait_timeout= 15;

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t31 set name='4zzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
insert into t31 values(5, 'xxxxxx');

connection con3;
use linpin;
send delete from t31;
#--real_sleep 1.5

connection con1;
--real_sleep 1
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
--real_sleep 1
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con3;
#--real_sleep 2
reap;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;
disconnect con3;

connection default;
SET GLOBAL innodb_lock_wait_timeout= @tmp_innodb_lock_wait_timeout;


################### AUTO-INC locks 2 ####################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t31 set name='4zzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
insert into t31 values(5, 'xxxxxx');

connection con3;
use linpin;
--error 1205
delete from t31;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con2;
#--real_sleep 1
commit;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

connection con3;
#--real_sleep 1
#reap;
--disable_warnings
drop table if exists tmp_t30;
--enable_warnings
create table tmp_t30(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
--enable_query_log
select count(*) from tmp_t30;
drop table tmp_t30;

disconnect con1;
disconnect con2;
disconnect con3;



connection default;

##!!!!!! start only for test
#--disable_warnings
#drop table if exists tmp_t30;
#--enable_warnings
#create table tmp_t30(lock_wait_string varchar(256));
#--disable_query_log
#eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t30;
#--enable_query_log
#select count(*) from tmp_t30;
#select * from tmp_t30;
#drop table tmp_t30;
##!!!!!!  end  only for test


SET GLOBAL innodb_lock_wait_timeout= @old_innodb_lock_wait_timeout;
SET GLOBAL transaction_isolation=	 @old_transaction_isolation;
SET GLOBAL lock_wait_timeout=	     @old_lock_wait_timeout;

drop table t30;
drop table t31;
drop database linpin;









# === Purpose ===
#
# This test case will verify the function of innodb lock wait log
#
#--source include/not_embedded.inc
--source include/not_windows.inc
#--source include/have_innodb.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--disable_warnings
drop database if exists linpin;
--enable_warnings

# Save the old values of these variables to be restored at the end
SET @old_transaction_isolation=	 	 @@global.transaction_isolation;
SET @old_innodb_lock_wait_timeout=	 @@global.innodb_lock_wait_timeout;
SET @old_lock_wait_timeout=	 		 @@global.lock_wait_timeout;

set GLOBAL transaction_isolation = 	 'READ-COMMITTED';
SET GLOBAL innodb_lock_wait_timeout= 1;
SET GLOBAL lock_wait_timeout=	     1;

create database linpin;
use linpin;

--disable_warnings
drop table if exists t40;
--enable_warnings

create table t40(id int , name varchar(80));
alter table t40 add index idx_id(id);

insert into t40 values(1,'linpin');
insert into t40 values(2,'lishiming');
insert into t40 values(3,'qinshihuang');
insert into t40 values(4,'hanwudi');
insert into t40 values(5,'5hangaozu');
insert into t40 values(6,'6hangaozu');
insert into t40 values(10,'5hangaozu');
insert into t40 values(11,'6hangaozu');
insert into t40 values(12,'5hangaozu');
insert into t40 values(13,'6hangaozu');


#########################################################
###### non-unique second index without primary key ######
#########################################################

############# two locks on the same record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t40 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
--error 1205
update t40 set name='2222zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

disconnect con1;
disconnect con2;


############ two locks on the diff record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t40 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
update t40 set name='2222zzzzzzzz' where id = 5;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

disconnect con1;
disconnect con2;


############# four locks on the same record #############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t40 set name='11111zzzzzzzz' where id = 4;

connection con2;
use linpin;
start transaction;
send update t40 set name='2222zzzzzzzz' where id = 4;

connection con3;
use linpin;
start transaction;
send update t40 set name='3333zzzzzzzz' where id = 4;

connection con4;
use linpin;
start transaction;
--error 1205
update t40 set name='3333zzzzzzzz' where id = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con3;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


############# two locks, two have one lock ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t40 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
send update t40 set name='5ddddddd' where id = 5;

connection con3;
use linpin;
start transaction;
update t40 set name='6dddddd' where id = 6;

connection con4;
use linpin;
start transaction;
--error 1205
update t40 set name='6dddd' where id = 6;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


################### update and insert ###################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t40 set name='5zzzzz' where id = 5;

connection con2;
use linpin;
start transaction;
insert into t40 values(100, 'xxxx');

connection con3;
use linpin;
start transaction;
insert into t40 values(4, 'xxxx');

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t40;
--enable_warnings
create table tmp_t40(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
--enable_query_log
select count(*) from tmp_t40;
drop table tmp_t40;

disconnect con1;
disconnect con2;
disconnect con3;




connection default;

##!!!!!! start only for test
#--disable_warnings
#drop table if exists tmp_t40;
#--enable_warnings
#create table tmp_t40(lock_wait_string varchar(256));
#--disable_query_log
#eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t40;
#--enable_query_log
#select count(*) from tmp_t40;
#select * from tmp_t40;
#drop table tmp_t40;
##!!!!!!  end  only for test


SET GLOBAL innodb_lock_wait_timeout= @old_innodb_lock_wait_timeout;
SET GLOBAL transaction_isolation=	 @old_transaction_isolation;
SET GLOBAL lock_wait_timeout=	     @old_lock_wait_timeout;

drop table t40;
drop database linpin;









# === Purpose ===
#
# This test case will verify the function of innodb lock wait log
#
#--source include/not_embedded.inc
--source include/not_windows.inc
#--source include/have_innodb.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--disable_warnings
drop database if exists linpin;
--enable_warnings

# Save the old values of these variables to be restored at the end
SET @old_transaction_isolation=	 	 @@global.transaction_isolation;
SET @old_innodb_lock_wait_timeout=	 @@global.innodb_lock_wait_timeout;
SET @old_lock_wait_timeout=	 		 @@global.lock_wait_timeout;

set GLOBAL transaction_isolation = 	 'READ-COMMITTED';
SET GLOBAL innodb_lock_wait_timeout= 1;
SET GLOBAL lock_wait_timeout=	     1;

create database linpin;
use linpin;

--disable_warnings
drop table if exists t50;
--enable_warnings

create table t50(id int primary key, name varchar(80),id2 int);
alter table t50 add index t50_idx(id2);

insert into t50 values(1,'linpin',1);
insert into t50 values(2,'lishiming',2);
insert into t50 values(3,'qinshihuang',3);
insert into t50 values(4,'hanwudi',4);
insert into t50 values(5,'5hangaozu',5);
insert into t50 values(6,'6hangaozu',6);
insert into t50 values(10,'5hangaozu',7);
insert into t50 values(11,'6hangaozu',8);
insert into t50 values(12,'5hangaozu',9);
insert into t50 values(13,'6hangaozu',10);


#########################################################
############# second index with primary key #############
#########################################################


############# two locks on the same record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t50 set name='11111zzzzzzzz' where id2 = 4;

connection con2;
use linpin;
start transaction;
--error 1205
update t50 set name='2222zzzzzzzz' where id2 = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;


############# two locks on the diff record ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t50 set name='11111zzzzzzzz' where id2 = 4;

connection con2;
use linpin;
start transaction;
update t50 set name='2222zzzzzzzz' where id2 = 5;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;


############# four locks on the same record #############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t50 set name='11111zzzzzzzz' where id2 = 4;

connection con2;
use linpin;
start transaction;
send update t50 set name='2222zzzzzzzz' where id2 = 4;

connection con3;
use linpin;
start transaction;
send update t50 set name='3333zzzzzzzz' where id2 = 4;

connection con4;
use linpin;
start transaction;
--error 1205
update t50 set name='3333zzzzzzzz' where id2 = 4;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con3;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


############# two locks, two have one lock ##############

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t50 set name='5zzzzz' where id2 = 5;

connection con2;
use linpin;
start transaction;
send update t50 set name='5ddddddd' where id2 = 5;

connection con3;
use linpin;
start transaction;
update t50 set name='6dddddd' where id2 = 6;

connection con4;
use linpin;
start transaction;
--error 1205
update t50 set name='6dddd' where id2 = 6;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


################### update and insert ###################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);
connect (con4,localhost,root,,);

connection con1;
use linpin;
start transaction;
update t50 set name='5zzzzz' where id2 = 5;

connection con2;
use linpin;
start transaction;
send insert into t50 values(5, 'xxxx', 5);

connection con3;
use linpin;
start transaction;
insert into t50 values(60, 'xxxx', 6);

connection con4;
use linpin;
start transaction;
insert into t50 values(30, 'xxxx', 3);

connection con1;
--real_sleep 1
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
--error 1205,1062
reap;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con4;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;
disconnect con3;
disconnect con4;


##################### table lock 1 ######################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection default;
SET @old_innodb_status_output_locks=	 	 @@global.innodb_status_output_locks;
set global innodb_status_output_locks = 	 on;

connection con1;
use linpin;
start transaction;
update t50 set name='5zzzzz' where id2 = 5;

connection con2;
use linpin;
start transaction;
insert into t50 values(50, 'xxxx', 5);

connection con3;
use linpin;
--error 1205
LOCK TABLES t50 read;

connection con1;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con3;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

disconnect con1;
disconnect con2;
disconnect con3;

connection default;
set global innodb_status_output_locks = 	 @old_innodb_status_output_locks;


##################### table lock 2 ######################

connect (con1,localhost,root,,);
connect (con2,localhost,root,,);
connect (con3,localhost,root,,);

connection con1;
use linpin;
LOCK TABLES t50 write;

connection con2;
use linpin;
start transaction;
send update t50 set name='5zzzzz' where id2 = 5;

connection con3;
use linpin;
--error 1205
insert into t50 values(5, 'xxxx', 5);

connection default;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con2;
--error 1205
reap;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con3;
commit;
--disable_warnings
drop table if exists tmp_t50;
--enable_warnings
create table tmp_t50(lock_wait_string varchar(256));
--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
--enable_query_log
select count(*) from tmp_t50;
drop table tmp_t50;

connection con1;
UNLOCK TABLES;

disconnect con1;
disconnect con2;
disconnect con3;




connection default;

##!!!!!! start only for test
#--disable_warnings
#drop table if exists tmp_t50;
#--enable_warnings
#create table tmp_t50(lock_wait_string varchar(256));
#--disable_query_log
#eval load data infile '$MYSQLTEST_VARDIR/mysqld.1/data/innodb_lock_wait.log' ignore into table tmp_t50;
#--enable_query_log
#select count(*) from tmp_t50;
#select * from tmp_t50;
#drop table tmp_t50;
##!!!!!!  end  only for test


SET GLOBAL innodb_lock_wait_timeout= @old_innodb_lock_wait_timeout;
SET GLOBAL transaction_isolation=	 @old_transaction_isolation;
SET GLOBAL lock_wait_timeout=	     @old_lock_wait_timeout;

drop table t50;
drop database linpin;
