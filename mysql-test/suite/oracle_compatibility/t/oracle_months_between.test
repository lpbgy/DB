#
#Test MONTHS_BETWEEN
#
# 创建测试数据库和测试表，并预制数据，为测试做准备
DROP DATABASE IF EXISTS test_db_months_between;
CREATE DATABASE test_db_months_between;
USE test_db_months_between;
CREATE TABLE testtb (id INT PRIMARY KEY, t DATE);
INSERT INTO testtb VALUES (1,'2020-01-01');
INSERT INTO testtb VALUES (2,'2020-06-08');

CREATE TABLE testtb2 (id INT PRIMARY KEY, t DATETIME);
INSERT INTO testtb2 VALUES (1,'2020-01-01 13:00:49');
INSERT INTO testtb2 VALUES (2,'2020-06-08 19:01:00');

CREATE TABLE testtb3 (id INT PRIMARY KEY, t DOUBLE);

# TEST MONTHS_BETWEEN using parameter select from table
SELECT MONTHS_BETWEEN((SELECT T FROM testtb WHERE id = 1), (SELECT T FROM testtb WHERE id = 2));
SELECT MONTHS_BETWEEN((SELECT T FROM testtb WHERE id = 2), (SELECT T FROM testtb WHERE id = 1));
SELECT MONTHS_BETWEEN((SELECT T FROM testtb2 WHERE id = 1), (SELECT T FROM testtb2 WHERE id = 2));
SELECT MONTHS_BETWEEN((SELECT T FROM testtb2 WHERE id = 2), (SELECT T FROM testtb2 WHERE id = 1));

# TEST MONTHS_BETWEEN with date funcs
SELECT MONTHS_BETWEEN(NOW(),CURDATE());
SELECT MONTHS_BETWEEN('2020-06-07','2020-06-06')+1;

# TEST MONTHS_BETWEEN in DML
INSERT INTO testtb3 VALUES (1,MONTHS_BETWEEN('2020-06-08 23:00:00','2019-06-09 15:24:00'));
INSERT INTO testtb3 VALUES (2,MONTHS_BETWEEN('2020-06-08 23:00:00','2020-06-01 15:24:00'));
SELECT * FROM testtb3;
SELECT * FROM testtb3 WHERE t = MONTHS_BETWEEN('2020-06-08 23:00:00','2019-06-09 15:24:00');
UPDATE testtb3 SET t = MONTHS_BETWEEN('2020-06-08 23:00:00','2020-06-08 15:24:00') WHERE id = 2;
UPDATE testtb3 SET t = MONTHS_BETWEEN('2020-06-08 23:00:00','2020-06-03 15:24:00') WHERE t = MONTHS_BETWEEN('2020-06-08 23:00:00','2019-06-09 15:24:00');
SELECT * FROM testtb3;
DELETE FROM testtb3 WHERE t = MONTHS_BETWEEN('2020-06-08 23:00:00','2020-06-08 15:24:00');
SELECT * FROM testtb3;

# TEST MONTHS_BETWEEN using parameter from TO_DATE
SELECT MONTHS_BETWEEN(TO_DATE('02-01-1999','MM-DD-YYYY'),TO_DATE('02-01-1998','MM-DD-YYYY'));
SELECT MONTHS_BETWEEN(TO_DATE('04-21-1999','MM-DD-YYYY'),TO_DATE('07-31-2020','MM-DD-YYYY'));
SELECT MONTHS_BETWEEN(TO_DATE('2020-06-06 16:28:49', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2019-05-21 20:00:03', 'YYYY-MM-DD HH24:MI:SS'));
SELECT MONTHS_BETWEEN(TO_DATE('2019-05-21 20:00:03', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2020-06-06 16:28:49', 'YYYY-MM-DD HH24:MI:SS'));

# TEST MONTHS_BETWEEN using number match default date format
SELECT MONTHS_BETWEEN(20200630,20190201);
SELECT MONTHS_BETWEEN(20190201,20200630);

# TEST MONTHS_BETWEEN using string match default date format
SELECT MONTHS_BETWEEN('2020-06-08 23:00:00','2019-02-02 23:00:00');
SELECT MONTHS_BETWEEN('2019-02-02 23:00:00','2020-06-08 23:00:00');

# deta = 0
SELECT MONTHS_BETWEEN('2020-06-08 23:00:00','2019-06-08 23:00:00');

# delta = days + 1 s
SELECT MONTHS_BETWEEN('2020-06-08 23:00:01','2019-02-02 23:00:00');
SELECT MONTHS_BETWEEN('2019-02-02 23:00:00','2020-06-08 23:00:01');

# delta = days + 1 min
SELECT MONTHS_BETWEEN('2020-06-08 23:01:00','2019-02-02 23:00:00');
SELECT MONTHS_BETWEEN('2019-02-02 23:00:00','2020-06-08 23:01:00');

# delta = days + 1 hour
SELECT MONTHS_BETWEEN('2020-06-08 22:00:00','2019-02-02 23:00:00');
SELECT MONTHS_BETWEEN('2019-02-02 22:00:00','2020-06-08 23:00:00');

# delta = 1 day
SELECT MONTHS_BETWEEN('2020-06-08','2020-06-09');
SELECT MONTHS_BETWEEN('2020-06-09','2020-06-08');

# delta = 1 month
SELECT MONTHS_BETWEEN('2020-06-08','2020-07-08');
SELECT MONTHS_BETWEEN('2020-07-08','2020-06-08');

# delta = 1 year
SELECT MONTHS_BETWEEN('2020-06-08','2021-06-08');
SELECT MONTHS_BETWEEN('2021-06-08','2020-06-08');

# delta = MAX
SELECT MONTHS_BETWEEN('9999-12-31 23:59:59','1000-01-01 00:00:00');
SELECT MONTHS_BETWEEN('1000-01-01 00:00:00','9999-12-31 23:59:59');
SELECT MONTHS_BETWEEN('9999-12-31 23:59:59','0001-01-01 00:00:00');
SELECT MONTHS_BETWEEN('0001-01-01 00:00:00','9999-12-31 23:59:59');

# TEST same day different month
SELECT MONTHS_BETWEEN('2020-12-02 00:00:00','2020-01-02 23:59:59');
SELECT MONTHS_BETWEEN('2020-01-02 00:00:00','2020-12-02 23:59:59');

# TEST same day different year
SELECT MONTHS_BETWEEN('2020-01-02','1999-01-02');
SELECT MONTHS_BETWEEN('1999-01-02','2020-01-02');

# TEST same day different month & year
SELECT MONTHS_BETWEEN('2020-05-02 23:59:59','1999-01-02 00:00:00');
SELECT MONTHS_BETWEEN('1999-01-02 00:00:00','2020-05-02 23:59:59');
SELECT MONTHS_BETWEEN('2020-03-02','1999-10-02');
SELECT MONTHS_BETWEEN('1999-10-02','2020-03-02');

# TEST both last days of months
SELECT MONTHS_BETWEEN('2020-05-31 12:00:00','1999-04-30 00:00:00');
SELECT MONTHS_BETWEEN('1999-04-30 00:00:00','2020-05-31 12:00:00');
SELECT MONTHS_BETWEEN('2020-02-29 23:59:59','2019-02-28 00:00:00');
SELECT MONTHS_BETWEEN('2019-02-28 00:00:00','2020-02-29 23:59:59');

# TEST different day & month & year
SELECT MONTHS_BETWEEN('2020-05-02','1999-01-02');
SELECT MONTHS_BETWEEN('1999-01-02','2020-05-02');
SELECT MONTHS_BETWEEN('2020-03-02','1999-10-02');
SELECT MONTHS_BETWEEN('1999-10-02','2020-03-02');

# TEST different day & month & year & time
SELECT MONTHS_BETWEEN('2020-05-29 12:24:32','1999-04-30 05:04:57');
SELECT MONTHS_BETWEEN('1999-04-30 05:04:57','2020-05-29 12:24:32');

# TEST different date format
SELECT MONTHS_BETWEEN(TO_DATE('2020-06-06 16:28:49', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2019-5-6', 'yyyy-mm-dd'));
SELECT MONTHS_BETWEEN(TO_DATE('2020-06-06 16:28:49', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2019-5-7', 'yyyy-mm-dd'));

# PREPARE
PREPARE stmt_months_between FROM 'SELECT MONTHS_BETWEEN(20200529,20100430) WHERE MONTHS_BETWEEN(20200529,20100430) > ?';
SET @a = 100;
EXECUTE stmt_months_between USING @a;

# PROCEDURE
--DELIMITER $$
CREATE OR REPLACE PROCEDURE select_m_b()
BEGIN
    DECLARE t INT DEFAULT 1;
    WHILE t < 3 DO
        SELECT MONTHS_BETWEEN('2020-06-09 10:45:59','2020-05-29 17:54:17');
        SET t = t + 1;
    END WHILE;
END $$
--DELIMITER ;
CALL select_m_b();

--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN('9999-12-31 23:59:59','0000-01-01 00:00:00');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN('0000-01-01 00:00:00','9999-12-31 23:59:59');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN('10000-01-02','1999-01-02');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN('1999-01-02','2020-28-02');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN(NULL,'1999-01-02');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN(TO_DATE(NULL,'YYYY-MM-DD'),'1999-01-02');
--error ER_CAL_MONTHS_BETWEEN_FAIL
SELECT MONTHS_BETWEEN(NULL,NULL);

# 清理测试数据
DROP DATABASE IF EXISTS test_db_months_between;
# End of ZSQL兼容Oracle的'MONTHS_BETWEEN'语法 tests
